<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Paciente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü¶∑</text></svg>">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      padding-top: 70px;
      overflow-x: hidden;
    }

    /* Ajustes responsivos para o navbar */
    .navbar {
      padding: 0.5rem 1rem;
    }
    .navbar-brand {
      font-size: 1.1rem;
    }
    @media (max-width: 576px) {
      .navbar-brand {
        font-size: 1rem;
      }
      .user-info {
        font-size: 0.85rem;
        margin-right: 10px;
      }
      .btn-outline-light {
        padding: 0.25rem 0.5rem;
        font-size: 0.85rem;
      }
    }

    /* Sidebar responsivo */
    .sidebar {
      background-color: #f8f9fa;
      height: auto;
      min-height: calc(100vh - 70px);
      padding-top: 20px;
      position: sticky;
      top: 70px;
      z-index: 1000;
    }
    .sidebar a {
      display: block;
      padding: 12px 20px;
      color: #333;
      text-decoration: none;
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease-in-out;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sidebar a:hover,
    .sidebar a.active {
      color: #007bff;
    }
    .sidebar a::after {
      content: "";
      position: absolute;
      bottom: 5px;
      left: 20px;
      width: 0;
      height: 2px;
      background-color: #007bff;
      transition: width 0.3s ease-in-out;
    }
    .sidebar a:hover::after,
    .sidebar a.active::after {
      width: 50px;
    }
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: -100%;
        width: 250px;
        transition: left 0.3s ease;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      }
      .sidebar.active {
        left: 0;
      }
      .content {
        margin-left: 0;
        width: 100%;
      }
      .navbar .navbar-toggler {
        display: block;
      }
    }
    @media (max-width: 576px) {
      .sidebar a {
        padding: 10px 15px;
        font-size: 0.9rem;
      }
    }

    /* Conte√∫do responsivo */
    .content {
      padding: 20px;
      transition: margin-left 0.3s ease;
    }
    .user-info {
      color: #fff;
      margin-right: 20px;
      font-size: 0.95rem;
    }
    @media (max-width: 768px) {
      .content {
        padding: 15px;
      }
      .saudacao {
        font-size: 1.5rem;
      }
      #descricaoPainel {
        font-size: 0.9rem;
      }
    }

    /* Cards de servi√ßo responsivos */
    .card-servico {
      height: 100%;
      display: flex;
      flex-direction: column;
      margin-bottom: 1rem;
      transition: transform 0.2s ease;
    }
    .card-servico:hover {
      transform: translateY(-5px);
    }
    .card-servico .card-img-top {
      height: 200px;
      object-fit: cover;
      width: 100%;
    }
    .card-servico .card-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: auto;
      padding: 1rem;
    }
    .card-servico .card-title {
      margin-bottom: 0.75rem;
    }
    .card-servico .card-text {
      flex: 1;
      overflow: hidden;
      margin-bottom: 1rem;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      min-height: 4.5rem;
    }
    .card-servico .btn {
      margin-top: auto;
    }
    .preco-servico {
      font-size: 1.25rem;
      font-weight: 600;
      color: #007bff;
      padding: 0.5rem 0;
    }
    .card-servico .d-flex {
      margin-top: auto;
      padding-top: 0.5rem;
      border-top: 1px solid rgba(0, 123, 255, 0.1);
    }
    @media (max-width: 768px) {
      .card-servico .card-img-top {
        height: 180px;
      }
      .card-servico .card-body {
        padding: 1rem;
      }
      .card-servico .card-title {
        font-size: 1.1rem;
      }
      .card-servico .card-text {
        font-size: 0.9rem;
        min-height: 4rem;
      }
      .preco-servico {
        font-size: 1.1rem;
      }
    }

    /* Tabela de agendamentos responsiva */
    .table-agendamentos {
      width: 100%;
      margin-bottom: 1rem;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
      overflow: hidden;
    }
    .table-agendamentos thead {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
    }
    .table-agendamentos thead th {
      font-weight: 500;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
      padding: 15px;
      border: none;
    }
    .table-agendamentos tbody tr {
      transition: all 0.2s ease;
      border-bottom: 1px solid #f0f0f0;
    }
    .table-agendamentos tbody tr:hover {
      background-color: #f8f9ff;
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    .table-agendamentos tbody td {
      padding: 15px;
      vertical-align: middle;
      color: #444;
      font-size: 0.95rem;
    }
    .table-agendamentos .btn-cancelar {
      padding: 6px 12px;
      font-size: 0.85rem;
      border-radius: 6px;
      transition: all 0.2s ease;
      background: #dc3545;
      border: none;
      color: white;
    }
    .table-agendamentos .btn-cancelar:hover {
      background: #c82333;
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(220, 53, 69, 0.2);
    }
    .data-horario {
      font-weight: 500;
      color: #2c3e50;
    }
    .servico-info {
      color: #666;
    }
    .dentista-info {
      color: #007bff;
      font-weight: 500;
    }
    .sem-agendamentos {
      text-align: center;
      padding: 40px 20px;
      color: #6c757d;
      font-size: 1.1rem;
      background: #f8f9fa;
      border-radius: 10px;
      margin: 20px 0;
    }
    @media (max-width: 768px) {
      .table-agendamentos {
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .table-agendamentos thead th {
        white-space: nowrap;
        padding: 10px;
        font-size: 0.8rem;
      }
      .table-agendamentos tbody td {
        padding: 10px;
        font-size: 0.85rem;
        white-space: nowrap;
      }
      .btn-cancelar {
        padding: 4px 8px;
        font-size: 0.8rem;
      }
    }

    /* Formul√°rios responsivos */
    .form-agendamento-container {
      position: relative;
    }
    .form-agendamento {
      position: relative;
      z-index: 1000;
      background: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-radius: 0.375rem;
      margin-top: 0;
      display: none;
    }
    .form-agendamento.active {
      display: block;
    }
    @media (max-width: 768px) {
      .form-agendamento {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 400px;
        max-height: 90vh;
        overflow-y: auto;
      }
      .form-agendamento .card {
        margin: 0;
      }
      .form-floating {
        margin-bottom: 0.75rem;
      }
      .form-floating > label {
        font-size: 0.9rem;
      }
      .form-floating > .form-control {
        height: calc(2.5rem + 2px);
        font-size: 0.9rem;
      }
    }

    /* Perfil responsivo */
    @media (max-width: 768px) {
      .card-body {
        padding: 1rem;
      }
      .form-floating {
        margin-bottom: 0.75rem;
      }
      .btn {
        width: 100%;
        margin-bottom: 0.5rem;
      }
      .d-flex.gap-2 {
        flex-direction: column;
      }
    }

    /* Mensagens de status responsivas */
    .alert {
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
    }
    @media (max-width: 576px) {
      .alert {
        font-size: 0.9rem;
        padding: 0.5rem 0.75rem;
      }
    }

    /* Bot√£o de menu para mobile */
    .navbar-toggler {
      display: none;
      border: none;
      padding: 0.25rem;
      margin-right: 0.5rem;
    }
    @media (max-width: 768px) {
      .navbar-toggler {
        display: block;
      }
    }

    /* Overlay para mobile quando o menu est√° aberto */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
    @media (max-width: 768px) {
      .sidebar-overlay.active {
        display: block;
      }
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
  <div class="container-fluid">
    <button class="navbar-toggler" type="button" onclick="toggleSidebar()">
      <i class="fas fa-bars text-white"></i>
    </button>
    <a class="navbar-brand fw-bold" href="#">Odonto Vida - Paciente</a>
    <div class="ms-auto d-flex align-items-center">
      <div class="user-info me-3" id="userNome">Bem-vindo!</div>
      <a href="index.html" class="btn btn-outline-light">Sair</a>
    </div>
  </div>
</nav>

<!-- Adicionar overlay para mobile -->
<div class="sidebar-overlay" onclick="toggleSidebar()"></div>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-2 sidebar">
      <a href="#" onclick="mudarConteudo('Servi√ßos', 'Veja abaixo os servi√ßos dispon√≠veis para voc√™.', this)" id="linkServicos">
        <i class="fas fa-tooth"></i> Servi√ßos
      </a>
      <a href="#" onclick="mudarConteudo('Meus Agendamentos', 'Veja seus agendamentos.', this)">
        <i class="fas fa-calendar"></i> Meus Agendamentos
      </a>
      <a href="#" onclick="mudarConteudo('Perfil', 'Gerencie suas informa√ß√µes.', this)">
        <i class="fas fa-user"></i> Perfil
      </a>
    </div>

    <!-- Conte√∫do -->
    <div class="col-md-10 content">
      <h2 class="saudacao">
        <i class="fas fa-user-circle"></i>
        <span id="tituloPainel">Servi√ßos</span>
      </h2>
      <p id="descricaoPainel" class="text-muted mb-4">Veja abaixo os servi√ßos dispon√≠veis para voc√™.</p>
      <div id="mensagemStatus" class="alert" style="display: none;"></div>
      <div id="conteudoDinamico"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let idPaciente = localStorage.getItem("idPaciente");
  const nomePaciente = localStorage.getItem("nomePaciente");
  const email = localStorage.getItem("emailPaciente") || "guilherme.paciente@gmail.com";
  const senha = localStorage.getItem("senhaPaciente") || "123";

  document.getElementById("userNome").textContent = "Bem-vindo, " + nomePaciente + "!";

  const conteudo = document.getElementById("conteudoDinamico");

  // Carrega automaticamente a se√ß√£o de Servi√ßos ao entrar
  window.onload = function() {
    mudarConteudo('Servi√ßos', 'Veja abaixo os servi√ßos dispon√≠veis para voc√™.', document.getElementById('linkServicos'));
  };

  function mudarConteudo(titulo, descricao, elementoLink = null) {
    document.getElementById("tituloPainel").textContent = titulo;
    document.getElementById("descricaoPainel").textContent = descricao;

    // Limpar mensagem de status ao mudar de se√ß√£o
    const mensagemStatus = document.getElementById("mensagemStatus");
    mensagemStatus.style.display = "none";
    mensagemStatus.textContent = "";
    mensagemStatus.className = "alert";

    document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("active"));
    if (elementoLink) elementoLink.classList.add("active");

    if (titulo === "Servi√ßos") {
      conteudo.innerHTML = `
        <div class="row row-cols-1 row-cols-md-3 g-4">
          <!-- Card Clareamento -->
          <div class="col">
            <div class="form-agendamento-container">
              <div class="card card-servico">
                <img src="https://cdn.pixabay.com/photo/2014/12/10/21/01/doctor-563429_1280.jpg" class="card-img-top" alt="Clareamento">
                <div class="card-body">
                  <h5 class="card-title">Clareamento</h5>
                  <p class="card-text">Clareamento dental profissional para um sorriso mais branco e radiante, realizado com produtos seguros e eficazes.</p>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="preco-servico">R$ 350,00</span>
                    <button class="btn btn-primary" onclick="abrirAgendamento('Clareamento', 'formClareamento')">Agendar</button>
                  </div>
                </div>
              </div>
              <div id="formClareamento" class="form-agendamento"></div>
            </div>
          </div>
          <!-- Card Restaura√ß√£o -->
          <div class="col">
            <div class="form-agendamento-container">
              <div class="card card-servico">
                <img src="https://cdn.pixabay.com/photo/2019/07/30/15/57/dentist-4373290_1280.jpg" class="card-img-top" alt="Restaura√ß√£o">
                <div class="card-body">
                  <h5 class="card-title">Restaura√ß√£o</h5>
                  <p class="card-text">Reparo de dentes danificados e c√°ries com materiais resistentes e est√©ticos, devolvendo a sa√∫de e beleza do seu sorriso.</p>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="preco-servico">R$ 280,00</span>
                    <button class="btn btn-primary" onclick="abrirAgendamento('Restaura√ß√£o', 'formRestauracao')">Agendar</button>
                  </div>
                </div>
              </div>
              <div id="formRestauracao" class="form-agendamento"></div>
            </div>
          </div>
          <!-- Card Ortodontia -->
          <div class="col">
            <div class="form-agendamento-container">
              <div class="card card-servico">
                <img src="https://cdn.pixabay.com/photo/2016/11/28/12/22/dentist-1864921_1280.jpg" class="card-img-top" alt="Ortodontia">
                <div class="card-body">
                  <h5 class="card-title">Ortodontia</h5>
                  <p class="card-text">Corre√ß√£o do posicionamento dos dentes com aparelhos modernos e eficientes, proporcionando um alinhamento perfeito para seu sorriso.</p>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="preco-servico">R$ 450,00</span>
                    <button class="btn btn-primary" onclick="abrirAgendamento('Ortodontia', 'formOrtodontia')">Agendar</button>
                  </div>
                </div>
              </div>
              <div id="formOrtodontia" class="form-agendamento"></div>
            </div>
          </div>
        </div>
      `;
    } else if (titulo === "Meus Agendamentos") {
      carregarMeusAgendamentos();
    } else if (titulo === "Perfil") {
      carregarPerfil();
    }
  }

  function carregarMeusAgendamentos() {
    console.log("Iniciando carregamento de agendamentos...");
    console.log("ID do paciente:", idPaciente);

    if (!idPaciente) {
        console.error("ID do paciente n√£o encontrado no localStorage");
        conteudo.innerHTML = `
            <div class="alert alert-danger">
                Erro: ID do paciente n√£o encontrado. Por favor, fa√ßa login novamente.
            </div>
        `;
        return;
    }

    fetch("http://localhost:8080/consultas/listar")
        .then(res => {
            if (!res.ok) {
                throw new Error(`Erro na requisi√ß√£o: ${res.status}`);
            }
            return res.json();
        })
        .then(consultas => {
            console.log("Todas as consultas recebidas:", consultas);

            const agora = new Date();

            // Filtrar consultas do paciente e que ainda n√£o passaram
            const consultasPaciente = consultas.filter(consulta => {
                if (consulta.pacienteId !== parseInt(idPaciente)) return false;
                if (consulta.status === "CANCELADA") return false;
                
                // Criar objeto Date com a data e hora da consulta
                const [ano, mes, dia] = consulta.data.split('-').map(Number);
                const [hora, minuto] = consulta.horario.split(':').map(Number);
                const dataHoraConsulta = new Date(ano, mes - 1, dia, hora, minuto);
                
                // Retornar apenas consultas futuras
                return dataHoraConsulta > agora;
            });

            console.log("Consultas futuras do paciente:", consultasPaciente);

            // Encontrar consultas canceladas por exclus√£o do doutor
            const consultasCanceladasPorExclusao = consultas.filter(c => 
                c.pacienteId === parseInt(idPaciente) &&
                c.status === "CANCELADA" && 
                c.motivoCancelamento === "Especialista n√£o est√° mais dispon√≠vel no sistema"
            );

            // Inicializar htmlContent
            let htmlContent = '';

            // Verificar se h√° consultas canceladas por exclus√£o do doutor
            if (consultasCanceladasPorExclusao.length > 0) {
                // Encontrar a data mais antiga de cancelamento
                const dataMaisAntigaCancelamento = consultasCanceladasPorExclusao.reduce((maisAntiga, consulta) => {
                    const dataCancelada = new Date(consulta.data);
                    return dataCancelada < maisAntiga ? dataCancelada : maisAntiga;
                }, new Date(9999, 11, 31));
                console.log("Data mais antiga de cancelamento:", dataMaisAntigaCancelamento);

                // Verificar se j√° houve algum agendamento ap√≥s o cancelamento
                const jaHouveAgendamento = consultasPaciente.some(consulta => {
                    const dataAgendamento = new Date(consulta.data);
                    const foiAgendado = consulta.status !== "CANCELADA";
                    const foiDepois = dataAgendamento >= dataMaisAntigaCancelamento;
                    console.log("Verificando consulta:", {
                        data: consulta.data,
                        status: consulta.status,
                        foiAgendado,
                        foiDepois
                    });
                    return foiAgendado && foiDepois;
                });
                console.log("J√° houve algum agendamento ap√≥s o cancelamento?", jaHouveAgendamento);

                // Mostrar mensagem apenas se nunca houve um agendamento ap√≥s o cancelamento
                if (!jaHouveAgendamento) {
                    console.log("Gerando mensagem pois nunca houve agendamento ap√≥s o cancelamento");
                    const amanha = new Date();
                    amanha.setDate(amanha.getDate() + 1);
                    while (amanha.getDay() === 0 || amanha.getDay() === 6) {
                        amanha.setDate(amanha.getDate() + 1);
                    }
                    const proximoDia = amanha.toISOString().split('T')[0];
                    const primeiraCancelada = consultasCanceladasPorExclusao[0];
                    const servico = primeiraCancelada.servico;

                    // Agrupar consultas por doutor para mostrar na mensagem
                    const consultasPorDoutor = consultasCanceladasPorExclusao.reduce((acc, consulta) => {
                        const nomeDr = consulta.dr.split(' - ')[0];
                        if (!acc[nomeDr]) {
                            acc[nomeDr] = [];
                        }
                        acc[nomeDr].push(consulta);
                        return acc;
                    }, {});

                    let mensagemDetalhada = '';
                    for (const [dr, consultas] of Object.entries(consultasPorDoutor)) {
                        mensagemDetalhada += `<p class="mb-2">Consultas com ${dr}:</p>`;
                        consultas.forEach(c => {
                            mensagemDetalhada += `<p class="ms-3 mb-1">- ${formatarData(c.data)} √†s ${c.horario}: ${c.servico}</p>`;
                        });
                    }

                    htmlContent += `
                        <div class="alert alert-warning mb-4">
                            <h5 class="alert-heading">‚ö†Ô∏è Consultas Canceladas</h5>
                            <p class="mb-2">Algumas das suas consultas foram canceladas porque os especialistas n√£o est√£o mais dispon√≠veis no sistema da cl√≠nica:</p>
                            ${mensagemDetalhada}
                            <hr>
                            <p class="mb-0">
                                <button class="btn btn-primary" onclick="agendarNovaConsulta('${servico}', '${proximoDia}', '08:00')">
                                    <i class="fas fa-calendar-plus me-1"></i>Agendar Nova Consulta
                                </button>
                            </p>
                        </div>
                    `;
                } else {
                    console.log("N√£o gerando mensagem pois j√° houve agendamento ap√≥s o cancelamento");
                }
            }

            // Ordenar consultas por data e hor√°rio
            consultasPaciente.sort((a, b) => {
                const dataA = new Date(a.data + "T" + a.horario);
                const dataB = new Date(b.data + "T" + b.horario);
                return dataA - dataB;
            });

            // Adicionar a tabela de consultas agendadas
            htmlContent += `
                <div class="table-responsive">
                    <table class="table table-agendamentos">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Hor√°rio</th>
                                <th>Especialista</th>
                                <th>Servi√ßo</th>
                                <th class="text-center">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="listaAgendamentos">
            `;

            if (consultasPaciente.length === 0) {
                htmlContent += `
                    <tr>
                        <td colspan="5">
                            <div class="sem-agendamentos">
                                <i class="fas fa-calendar-times mb-3" style="font-size: 2rem;"></i>
                                <p class="mb-0">Voc√™ n√£o possui consultas agendadas.</p>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                consultasPaciente.forEach(consulta => {
                    const nomeDr = consulta.dr.split(' - ')[0];
                    htmlContent += `
                        <tr>
                            <td class="data-horario">${formatarData(consulta.data)}</td>
                            <td class="data-horario">${consulta.horario}</td>
                            <td class="dentista-info">${nomeDr}</td>
                            <td class="servico-info">${consulta.servico}</td>
                            <td class="text-center">
                                <button class="btn-cancelar" onclick="cancelarAgendamento(${consulta.id})">
                                    <i class="fas fa-times-circle me-1"></i>Cancelar
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }

            htmlContent += `
                        </tbody>
                    </table>
                </div>
            `;

            // Atualizar o conte√∫do da p√°gina
            conteudo.innerHTML = htmlContent;
        })
        .catch(error => {
            console.error("Erro detalhado ao carregar agendamentos:", error);
            conteudo.innerHTML = `
                <div class="alert alert-danger">
                    Erro ao carregar agendamentos: ${error.message}
                </div>
            `;
        });
  }

  function formatarData(data) {
    const [ano, mes, dia] = data.split('-');
    return `${dia}/${mes}/${ano}`;
  }

  function cancelarAgendamento(id) {
    if (confirm("Tem certeza que deseja cancelar este agendamento?")) {
      // Primeiro, buscar os detalhes da consulta
      fetch(`http://localhost:8080/consultas/buscar/${id}`)
        .then(res => res.json())
        .then(consulta => {
          // Calcular a diferen√ßa de horas entre agora e a consulta
          const dataConsulta = new Date(consulta.data + 'T' + consulta.horario);
          const agora = new Date();
          const diferencaHoras = (dataConsulta - agora) / (1000 * 60 * 60);
          
          // Se for menos de 24h, mostrar aviso
          if (diferencaHoras < 24) {
            if (!confirm("‚ö†Ô∏è Aten√ß√£o! Voc√™ est√° cancelando com menos de 24h de anteced√™ncia. Deseja continuar?")) {
              return;
            }
          }

          // Usar o endpoint espec√≠fico de cancelamento
          return fetch(`http://localhost:8080/consultas/${id}/cancelar`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json"
            }
          });
        })
        .then(response => {
          if (!response.ok) {
            throw new Error("Erro ao cancelar agendamento");
          }
          const mensagemStatus = document.getElementById("mensagemStatus");
          mensagemStatus.textContent = "‚úÖ Agendamento cancelado com sucesso!";
          mensagemStatus.className = "alert alert-success";
          mensagemStatus.style.display = "block";
          carregarMeusAgendamentos(); // Recarrega a lista
        })
        .catch(error => {
          const mensagemStatus = document.getElementById("mensagemStatus");
          mensagemStatus.textContent = "‚ùå Erro ao cancelar agendamento: " + error.message;
          mensagemStatus.className = "alert alert-danger";
          mensagemStatus.style.display = "block";
        });
    }
  }

  function abrirAgendamento(servico, containerId) {
    const nomePaciente = localStorage.getItem("nomePaciente") || "Paciente";

    // Primeiro, esconder todos os formul√°rios
    document.querySelectorAll('.form-agendamento').forEach(form => {
      form.classList.remove('active');
      form.innerHTML = '';
    });

    // Mostrar o formul√°rio selecionado
    const formContainer = document.getElementById(containerId);
    formContainer.classList.add('active');
    formContainer.innerHTML = `
      <div class="card p-3">
        <h6 class="mb-3">Agendar: ${servico}</h6>
        <form onsubmit="return confirmarAgendamento(event, '${servico}', '${containerId}')" id="formAgendamento">
          <div class="form-floating mb-2">
            <input type="text" class="form-control" id="nomeAgendamento" value="${nomePaciente}" disabled>
            <label for="nomeAgendamento">Nome</label>
          </div>
          <div class="form-floating mb-2">
            <select class="form-select" id="dentistaAgendamento" required onchange="verificarHorariosDisponiveis()">
              <option value="">Carregando dentistas...</option>
            </select>
            <label for="dentistaAgendamento">Dr(a)</label>
          </div>
          <div class="form-floating mb-2">
            <input type="date" 
                   class="form-control" 
                   id="dataAgendamento" 
                   required 
                   onchange="validarDataAgendamento(this.value)"
                   oninput="validarDataAgendamento(this.value)"
                   onkeydown="return false"
                   onpaste="return false"
                   oncontextmenu="return false"
                   autocomplete="off">
            <label for="dataAgendamento">Data</label>
            <small class="text-muted">N√£o √© poss√≠vel agendar em finais de semana.</small>
          </div>
          <div class="form-floating mb-2">
            <select class="form-select" id="horarioAgendamento" required>
              <option value="">Selecione o hor√°rio</option>
            </select>
            <label for="horarioAgendamento">Hor√°rio</label>
            ${servico === "Restaura√ß√£o" ? '<small class="text-muted">Este servi√ßo tem dura√ß√£o m√≠nima de 2 horas.</small>' : ''}
          </div>
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-success" id="btnConfirmarAgendamento">Confirmar</button>
            <button type="button" class="btn btn-secondary" onclick="fecharFormulario('${containerId}')">Cancelar</button>
          </div>
        </form>
      </div>
    `;

    const hoje = new Date();
    const yyyy = hoje.getFullYear();
    const mm = String(hoje.getMonth() + 1).padStart(2, '0');
    const dd = String(hoje.getDate()).padStart(2, '0');
    const dataMinima = `${yyyy}-${mm}-${dd}`;
    
    setTimeout(() => {
      const inputData = document.getElementById("dataAgendamento");
      inputData.setAttribute("min", dataMinima);
      
      // Adicionar evento para validar a data selecionada
      inputData.addEventListener("change", function(e) {
        e.preventDefault();
        validarDataAgendamento(this.value);
      });

      // Prevenir sele√ß√£o direta de datas
      inputData.addEventListener("keydown", function(e) {
        e.preventDefault();
        return false;
      });

      // Desabilitar o bot√£o de confirmar inicialmente
      document.getElementById("btnConfirmarAgendamento").disabled = true;
    }, 50);

    fetch("http://localhost:8080/funcionarios/listar")
      .then(res => res.json())
      .then(funcionarios => {
        const select = document.getElementById("dentistaAgendamento");
        select.innerHTML = '<option value="">Selecione o especialista</option>';
        funcionarios.forEach(f => {
          const option = document.createElement("option");
          const valorCompleto = `Dr(a) ${f.nome} - CRO=${f.cro}`;
          option.value = valorCompleto; // Mant√©m o valor completo para o backend
          option.textContent = `Dr(a) ${f.nome}`; // Mostra apenas o nome no select
          select.appendChild(option);
        });
      })
      .catch(() => {
        const select = document.getElementById("dentistaAgendamento");
        select.innerHTML = '<option value="">Erro ao carregar dentistas</option>';
      });

    gerarHorarios();
  }

  function fecharFormulario(containerId) {
    const formContainer = document.getElementById(containerId);
    formContainer.classList.remove('active');
    formContainer.innerHTML = '';
  }

  function verificarHorariosDisponiveis() {
    const data = document.getElementById("dataAgendamento").value;
    const dr = document.getElementById("dentistaAgendamento").value;
    const servico = document.querySelector('.card-title').textContent; // Pega o servi√ßo selecionado
    
    if (!data || !dr) return;

    // Buscar agendamentos existentes
    fetch("http://localhost:8080/consultas/listar")
      .then(res => res.json())
      .then(consultas => {
        // Filtrar consultas para a data e dentista selecionados, ignorando as canceladas
        const consultasFiltradas = consultas.filter(consulta => 
          consulta.data === data && 
          consulta.dr === dr && 
          consulta.status !== "CANCELADA"
        );

        // Obter hor√°rios j√° agendados e seus per√≠odos bloqueados
        const horariosBloqueados = new Set();
        consultasFiltradas.forEach(consulta => {
          const [hora, minuto] = consulta.horario.split(':').map(Number);
          
          // Se for Restaura√ß√£o, bloqueia 2 horas
          if (consulta.servico === "Restaura√ß√£o") {
            // Adiciona o hor√°rio atual
            horariosBloqueados.add(consulta.horario);
            
            // Adiciona o pr√≥ximo hor√°rio (1 hora depois)
            const proximaHora = hora + 1;
            if (proximaHora < 18) { // Verifica se n√£o passa do hor√°rio de funcionamento
              horariosBloqueados.add(`${String(proximaHora).padStart(2, '0')}:00`);
            }
          } else {
            // Para outros servi√ßos, bloqueia apenas o hor√°rio atual
            horariosBloqueados.add(consulta.horario);
          }
        });

        // Atualizar select de hor√°rios
        const selectHorario = document.getElementById("horarioAgendamento");
        const options = selectHorario.options;

        // Desabilitar hor√°rios ocupados
        for (let i = 0; i < options.length; i++) {
          const option = options[i];
          const horario = option.value;
          
          if (horariosBloqueados.has(horario)) {
            option.disabled = true;
            option.textContent = `${horario} (Indispon√≠vel)`;
          } else {
            // Se for Restaura√ß√£o, verifica se o hor√°rio n√£o conflita com outro servi√ßo
            if (servico === "Restaura√ß√£o") {
              const [hora] = horario.split(':').map(Number);
              const proximaHora = hora + 1;
              const proximoHorario = `${String(proximaHora).padStart(2, '0')}:00`;
              
              // Se o pr√≥ximo hor√°rio estiver bloqueado, este tamb√©m deve estar
              if (horariosBloqueados.has(proximoHorario)) {
                option.disabled = true;
                option.textContent = `${horario} (Conflito com outro servi√ßo)`;
              } else {
                option.disabled = false;
                option.textContent = horario;
              }
            } else {
              option.disabled = false;
              option.textContent = horario;
            }
          }
        }

        // Se o hor√°rio selecionado estiver ocupado, limpar a sele√ß√£o
        if (horariosBloqueados.has(selectHorario.value)) {
          selectHorario.value = "";
        }

        // Adicionar mensagem informativa para Restaura√ß√£o
        const mensagemStatus = document.getElementById("mensagemStatus");
        if (servico === "Restaura√ß√£o") {
          mensagemStatus.innerHTML = `
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              O servi√ßo de Restaura√ß√£o tem dura√ß√£o m√≠nima de 2 horas. 
              Durante este per√≠odo, o dentista n√£o estar√° dispon√≠vel para outros atendimentos.
            </div>
          `;
          mensagemStatus.style.display = "block";
        } else {
          mensagemStatus.style.display = "none";
        }
      })
      .catch(error => {
        console.error("Erro ao buscar hor√°rios dispon√≠veis:", error);
      });
  }

  function gerarHorarios() {
    const selectHorario = document.getElementById("horarioAgendamento");
    selectHorario.innerHTML = '<option value="">Selecione o hor√°rio</option>';
    
    const horariosDisponiveis = [];

    // Gerar hor√°rios de hora em hora, das 8h √†s 17h
    for (let hora = 8; hora < 18; hora++) {
      const horaFormatada = String(hora).padStart(2, '0');
      horariosDisponiveis.push(`${horaFormatada}:00`);
    }

    horariosDisponiveis.forEach(horario => {
      const option = document.createElement("option");
      option.value = horario;
      option.textContent = horario;
      selectHorario.appendChild(option);
    });
  }

  function validarDataAgendamento(data) {
    if (!data) {
      document.getElementById("btnConfirmarAgendamento").disabled = true;
      return false;
    }

    const dataSelecionada = new Date(data + 'T00:00:00');
    const diaSemana = dataSelecionada.getDay(); // 0 = Domingo, 6 = S√°bado
    const mensagemStatus = document.getElementById("mensagemStatus");
    const inputData = document.getElementById("dataAgendamento");
    const btnConfirmar = document.getElementById("btnConfirmarAgendamento");
    const form = document.getElementById("formAgendamento");

    // Verificar se √© fim de semana
    if (diaSemana === 0 || diaSemana === 6) {
      mensagemStatus.textContent = "‚ùå N√£o √© poss√≠vel agendar em finais de semana.";
      mensagemStatus.className = "alert alert-danger";
      mensagemStatus.style.display = "block";
      inputData.value = ""; // Limpa a data selecionada
      btnConfirmar.disabled = true;
      form.classList.add("was-validated");
      return false;
    }

    // Verificar se a data √© v√°lida (n√£o √© passado)
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    
    if (dataSelecionada < hoje) {
      mensagemStatus.textContent = "‚ùå N√£o √© poss√≠vel agendar para datas passadas.";
      mensagemStatus.className = "alert alert-danger";
      mensagemStatus.style.display = "block";
      inputData.value = "";
      btnConfirmar.disabled = true;
      form.classList.add("was-validated");
      return false;
    }

    // Se passou por todas as valida√ß√µes
    mensagemStatus.style.display = "none";
    btnConfirmar.disabled = false;
    form.classList.remove("was-validated");
    verificarHorariosDisponiveis();
    return true;
  }

  function confirmarAgendamento(e, servico, containerId) {
    e.preventDefault();

    const nome = document.getElementById("nomeAgendamento").value;
    const data = document.getElementById("dataAgendamento").value;
    const horario = document.getElementById("horarioAgendamento").value;
    const dr = document.getElementById("dentistaAgendamento").value;

    // Valida√ß√£o rigorosa da data
    const dataSelecionada = new Date(data + 'T00:00:00');
    const diaSemana = dataSelecionada.getDay();
    
    if (diaSemana === 0 || diaSemana === 6) {
        const mensagemStatus = document.getElementById("mensagemStatus");
        mensagemStatus.textContent = "‚ùå N√£o √© poss√≠vel agendar em finais de semana.";
        mensagemStatus.className = "alert alert-danger";
        mensagemStatus.style.display = "block";
        return false;
    }

    // Resto das valida√ß√µes
    if (!idPaciente) {
        const mensagemStatus = document.getElementById("mensagemStatus");
        mensagemStatus.textContent = "‚ùå Erro: ID do paciente n√£o encontrado. Por favor, fa√ßa login novamente.";
        mensagemStatus.className = "alert alert-danger";
        mensagemStatus.style.display = "block";
        return false;
    }

    if (!data) {
        const mensagemStatus = document.getElementById("mensagemStatus");
        mensagemStatus.textContent = "‚ùå Erro: Por favor, selecione uma data.";
        mensagemStatus.className = "alert alert-danger";
        mensagemStatus.style.display = "block";
        return false;
    }

    // Verificar se j√° existe um agendamento para o mesmo dia
    fetch("http://localhost:8080/consultas/listar")
        .then(res => res.json())
        .then(consultas => {
            const consultaExistente = consultas.find(consulta => 
                consulta.pacienteId === parseInt(idPaciente) && 
                consulta.data === data && 
                consulta.status !== "CANCELADA"
            );

            if (consultaExistente) {
                const mensagemStatus = document.getElementById("mensagemStatus");
                mensagemStatus.textContent = `‚ùå Voc√™ j√° tem um agendamento para ${formatarData(data)} √†s ${consultaExistente.horario} com ${consultaExistente.dr.split(' - ')[0]} (${consultaExistente.servico}). N√£o √© poss√≠vel agendar mais de uma consulta por dia.`;
                mensagemStatus.className = "alert alert-danger";
                mensagemStatus.style.display = "block";
                return false;
            }

            // Se n√£o existe consulta no mesmo dia, prossegue com o agendamento
            const dadosAgendamento = {
                nome: nome,
                data: data,
                horario: horario,
                dr: dr,
                servico: servico,
                pacienteId: parseInt(idPaciente)
            };

            console.log("Dados sendo enviados:", dadosAgendamento);

            return fetch("http://localhost:8080/consultas/criar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(dadosAgendamento)
            });
        })
        .then(async response => {
            if (!response) return; // Se retornou false da valida√ß√£o anterior
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Erro ao criar agendamento: ${errorText}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data) return; // Se retornou false da valida√ß√£o anterior
            const mensagemStatus = document.getElementById("mensagemStatus");
            mensagemStatus.textContent = `‚úÖ Agendamento de ${servico} confirmado para ${data.data} √†s ${data.horario}.`;
            mensagemStatus.className = "alert alert-success";
            mensagemStatus.style.display = "block";
            fecharFormulario(containerId);
            carregarMeusAgendamentos(); // Recarrega a lista de agendamentos
        })
        .catch(error => {
            const mensagemStatus = document.getElementById("mensagemStatus");
            mensagemStatus.textContent = "‚ùå " + error.message;
            mensagemStatus.className = "alert alert-danger";
            mensagemStatus.style.display = "block";
            console.error("Erro detalhado:", error);
        });

    return false;
  }

  function carregarPerfil() {
    console.log("Carregando perfil do paciente ID:", idPaciente);
    fetch(`http://localhost:8080/paciente/listar/${idPaciente}`)
      .then(res => {
        if (!res.ok) {
          throw new Error("Erro ao buscar dados do paciente");
        }
        return res.json();
      })
      .then(paciente => {
        console.log("Dados recebidos do paciente:", paciente);
        
        let dataFormatada = '';
        if (paciente.dataNascimento) {
          try {
            const data = new Date(paciente.dataNascimento);
            if (!isNaN(data.getTime())) {
              dataFormatada = data.toISOString().split('T')[0];
            } else {
              console.error("Data inv√°lida recebida:", paciente.dataNascimento);
            }
          } catch (error) {
            console.error("Erro ao formatar data:", error);
          }
        }
        
        conteudo.innerHTML = `
          <div class="card">
            <div class="card-body">
              <h5 class="card-title mb-4">Dados do Perfil</h5>
              <form id="formPerfil" onsubmit="return salvarAlteracoes(event)">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <div class="form-floating">
                      <input type="text" class="form-control" id="nomePerfil" value="${paciente.nome}" required onchange="verificarAlteracoes()">
                      <label for="nomePerfil">Nome</label>
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <div class="form-floating">
                      <input type="email" class="form-control" id="emailPerfil" value="${paciente.email}" required onchange="verificarAlteracoes()">
                      <label for="emailPerfil">E-mail</label>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <div class="form-floating">
                      <input type="text" class="form-control" id="cpfPerfil" value="${paciente.cpf}" disabled>
                      <label for="cpfPerfil">CPF</label>
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <div class="form-floating">
                      <input type="date" class="form-control" id="dataNascimentoPerfil" value="${dataFormatada}" required onchange="verificarAlteracoes()">
                      <label for="dataNascimentoPerfil">Data de Nascimento</label>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <div class="form-floating position-relative">
                      <input type="password" class="form-control" id="senhaAtual" value="${paciente.senha}" onchange="verificarAlteracoes()">
                      <label for="senhaAtual">Senha Atual</label>
                      <button type="button" class="btn btn-link position-absolute end-0 top-50 translate-middle-y" onclick="togglePasswordVisibility('senhaAtual')">
                        <i class="fas fa-eye"></i>
                      </button>
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <div class="form-floating position-relative">
                      <input type="password" class="form-control" id="novaSenha" placeholder="Nova senha" onchange="verificarAlteracoes()">
                      <label for="novaSenha">Nova Senha (opcional)</label>
                      <button type="button" class="btn btn-link position-absolute end-0 top-50 translate-middle-y" onclick="togglePasswordVisibility('novaSenha')">
                        <i class="fas fa-eye"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="d-flex gap-2 mt-4">
                  <button type="submit" class="btn btn-primary" id="btnSalvar" disabled>
                    <i class="fas fa-save"></i> Salvar Altera√ß√µes
                  </button>
                  <button type="button" class="btn btn-danger" onclick="confirmarExclusaoConta()">
                    <i class="fas fa-trash"></i> Excluir Conta
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;

        window.valoresOriginais = {
          nome: paciente.nome,
          email: paciente.email,
          cpf: paciente.cpf,
          dataNascimento: dataFormatada,
          senha: paciente.senha
        };
      })
      .catch(error => {
        console.error("Erro ao carregar perfil:", error);
        conteudo.innerHTML = `
          <div class="alert alert-danger">
            Erro ao carregar dados do perfil: ${error.message}
          </div>
        `;
      });
  }

  function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    const icon = input.nextElementSibling.nextElementSibling.querySelector('i');
    
    if (input.type === 'password') {
      input.type = 'text';
      icon.classList.remove('fa-eye');
      icon.classList.add('fa-eye-slash');
    } else {
      input.type = 'password';
      icon.classList.remove('fa-eye-slash');
      icon.classList.add('fa-eye');
    }
  }

  function verificarAlteracoes() {
    const btnSalvar = document.getElementById("btnSalvar");
    const nome = document.getElementById("nomePerfil").value;
    const email = document.getElementById("emailPerfil").value;
    const senhaAtual = document.getElementById("senhaAtual").value;
    const novaSenha = document.getElementById("novaSenha").value;
    const dataNascimento = document.getElementById("dataNascimentoPerfil").value;

    // Validar idade m√≠nima ao verificar altera√ß√µes
    if (dataNascimento && !validarIdadeMinima(dataNascimento)) {
        const mensagemStatus = document.getElementById("mensagemStatus");
        mensagemStatus.textContent = "‚ùå O paciente deve ter pelo menos 14 anos de idade.";
        mensagemStatus.className = "alert alert-danger";
        mensagemStatus.style.display = "block";
        btnSalvar.disabled = true;
        return;
    }

    const houveAlteracao = 
        nome !== window.valoresOriginais.nome ||
        email !== window.valoresOriginais.email ||
        senhaAtual !== window.valoresOriginais.senha ||
        novaSenha !== "" ||
        dataNascimento !== window.valoresOriginais.dataNascimento;

    btnSalvar.disabled = !houveAlteracao;
    
    // Limpar mensagem de erro se n√£o houver problemas
    if (houveAlteracao && validarIdadeMinima(dataNascimento)) {
        const mensagemStatus = document.getElementById("mensagemStatus");
        mensagemStatus.style.display = "none";
    }
  }

  function validarIdadeMinima(dataNascimento) {
    const hoje = new Date();
    const dataNasc = new Date(dataNascimento);
    
    // Calcular a idade
    let idade = hoje.getFullYear() - dataNasc.getFullYear();
    const mesAtual = hoje.getMonth();
    const mesNasc = dataNasc.getMonth();
    
    // Ajustar a idade se ainda n√£o fez anivers√°rio este ano
    if (mesAtual < mesNasc || (mesAtual === mesNasc && hoje.getDate() < dataNasc.getDate())) {
        idade--;
    }
    
    return idade >= 14;
  }

  async function verificarConexaoServidor() {
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 segundos timeout

        const response = await fetch("http://localhost:8080/paciente/listar", {
            method: "HEAD",
            signal: controller.signal
        });

        clearTimeout(timeoutId);
        return response.ok;
    } catch (error) {
        if (error.name === 'AbortError') {
            throw new Error("O servidor demorou muito para responder. Verifique se o servidor est√° rodando.");
        }
        throw new Error("O servidor n√£o est√° respondendo. Verifique se o servidor backend est√° rodando na porta 8080.");
    }
  }

  async function verificarEmailExistente(email, idAtual) {
    const mensagemStatus = document.getElementById("mensagemStatus");
    const timeout = 5000; // 5 segundos por requisi√ß√£o

    async function verificarEmailEmEntidade(url, entidade) {
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);

            console.log(`Verificando email em ${entidade}...`);
            const response = await fetch(url, {
                signal: controller.signal,
                headers: {
                    'Accept': 'application/json'
                }
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                throw new Error(`Erro ao verificar ${entidade}: ${response.status}`);
            }

            const dados = await response.json();
            const emailExiste = dados.some(item => {
                if (entidade === 'pacientes') {
                    return item.email === email && item.id !== parseInt(idAtual);
                }
                return item.email === email;
            });

            console.log(`Verifica√ß√£o em ${entidade} conclu√≠da: ${emailExiste ? 'email encontrado' : 'email n√£o encontrado'}`);
            return emailExiste;

        } catch (error) {
            console.error(`Erro ao verificar ${entidade}:`, error);
            throw new Error(`Erro ao verificar ${entidade}: ${error.message}`);
        }
    }

    try {
        // Verificar conex√£o com o servidor primeiro
        try {
            console.log("Verificando conex√£o com o servidor...");
            const response = await fetch("http://localhost:8080/paciente/listar", {
                method: "HEAD",
                signal: AbortSignal.timeout(timeout)
            });
            
            if (!response.ok) {
                throw new Error("Servidor n√£o est√° respondendo corretamente");
            }
            console.log("Conex√£o com o servidor OK");
        } catch (error) {
            console.error("Erro ao verificar conex√£o:", error);
            throw new Error("N√£o foi poss√≠vel conectar ao servidor. Verifique se o servidor est√° rodando.");
        }

        // Verificar sequencialmente em cada entidade
        console.log("Iniciando verifica√ß√£o de email...");
        
        // Verificar em pacientes
        const existeEmPacientes = await verificarEmailEmEntidade("http://localhost:8080/paciente/listar", "pacientes");
        if (existeEmPacientes) {
            console.log("Email encontrado em pacientes");
            return true;
        }

        // Verificar em administradores (endpoint corrigido)
        const existeEmAdmins = await verificarEmailEmEntidade("http://localhost:8080/administrador/administradores", "administradores");
        if (existeEmAdmins) {
            console.log("Email encontrado em administradores");
            return true;
        }

        // Verificar em funcion√°rios
        const existeEmFuncionarios = await verificarEmailEmEntidade("http://localhost:8080/funcionarios/listar", "funcion√°rios");
        if (existeEmFuncionarios) {
            console.log("Email encontrado em funcion√°rios");
            return true;
        }

        console.log("Email n√£o encontrado em nenhuma entidade");
        return false;

    } catch (error) {
        console.error("Erro detalhado ao verificar email:", error);
        
        // Mensagens de erro mais espec√≠ficas e amig√°veis
        let mensagemErro;
        if (error.message.includes("conectar ao servidor")) {
            mensagemErro = "‚ùå N√£o foi poss√≠vel conectar ao servidor. Verifique se o servidor est√° rodando na porta 8080.";
        } else if (error.message.includes("timeout") || error.message.includes("abort")) {
            mensagemErro = "‚ùå A verifica√ß√£o demorou muito tempo. Por favor, tente novamente.";
        } else if (error.message.includes("pacientes") || error.message.includes("administradores") || error.message.includes("funcion√°rios")) {
            mensagemErro = "‚ùå Erro ao verificar disponibilidade do email. Por favor, tente novamente.";
        } else {
            mensagemErro = "‚ùå Erro ao verificar email. Por favor, tente novamente.";
        }
        
        mensagemStatus.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <div>
                    ${mensagemErro}
                    <br>
                    <small class="text-muted">Se o problema persistir, entre em contato com o suporte.</small>
                </div>
            </div>
        `;
        mensagemStatus.className = "alert alert-danger";
        mensagemStatus.style.display = "block";
        throw error;
    }
  }

  async function salvarAlteracoes(e) {
    e.preventDefault();

    const mensagemStatus = document.getElementById("mensagemStatus");
    mensagemStatus.style.display = "none"; // Limpar mensagens anteriores

    const senhaAtual = document.getElementById("senhaAtual").value;
    const novaSenha = document.getElementById("novaSenha").value;
    const dataNascimento = document.getElementById("dataNascimentoPerfil").value;
    const email = document.getElementById("emailPerfil").value;

    // Valida√ß√µes b√°sicas primeiro
    if (!dataNascimento) {
        mensagemStatus.textContent = "‚ùå Por favor, selecione uma data de nascimento v√°lida.";
        mensagemStatus.className = "alert alert-danger";
        mensagemStatus.style.display = "block";
        return false;
    }

    if (!validarIdadeMinima(dataNascimento)) {
        mensagemStatus.textContent = "‚ùå O paciente deve ter pelo menos 14 anos de idade.";
        mensagemStatus.className = "alert alert-danger";
        mensagemStatus.style.display = "block";
        return false;
    }

    // Verificar se o email foi alterado
    if (email !== window.valoresOriginais.email) {
        try {
            // Mostrar mensagem de carregamento com √≠cone
            mensagemStatus.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <div>Verificando disponibilidade do email...</div>
                </div>
            `;
            mensagemStatus.className = "alert alert-info";
            mensagemStatus.style.display = "block";

            const emailExiste = await verificarEmailExistente(email, idPaciente);
            
            if (emailExiste) {
                mensagemStatus.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-times-circle me-2"></i>
                        <div>Este email j√° est√° cadastrado.</div>
                    </div>
                `;
                mensagemStatus.className = "alert alert-danger";
                mensagemStatus.style.display = "block";
                return false;
            }
        } catch (error) {
            // O erro j√° foi tratado na fun√ß√£o verificarEmailExistente
            return false;
        }
    }

    if (novaSenha && novaSenha === senhaAtual) {
        mensagemStatus.textContent = "‚ùå A nova senha n√£o pode ser igual √† senha atual.";
        mensagemStatus.className = "alert alert-danger";
        mensagemStatus.style.display = "block";
        return false;
    }

    const dataFormatada = new Date(dataNascimento).toISOString().split('T')[0];

    const dadosAtualizados = {
        id: parseInt(idPaciente),
        nome: document.getElementById("nomePerfil").value,
        email: email,
        cpf: document.getElementById("cpfPerfil").value,
        dataNascimento: dataFormatada,
        senha: novaSenha || senhaAtual
    };

    try {
        const response = await fetch(`http://localhost:8080/paciente/atualizar/${idPaciente}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(dadosAtualizados)
        });

        if (!response.ok) {
            throw new Error("Erro ao atualizar dados");
        }

        const data = await response.json();
        
        if (novaSenha) {
            const mensagemStatus = document.getElementById("mensagemStatus");
            mensagemStatus.textContent = "‚úÖ Senha alterada com sucesso! Por favor, fa√ßa login novamente com sua nova senha.";
            mensagemStatus.className = "alert alert-success";
            mensagemStatus.style.display = "block";
            
            setTimeout(() => {
                localStorage.clear();
                window.location.href = "login-paciente.html";
            }, 2000);
            return false;
        }

        const mensagemStatus = document.getElementById("mensagemStatus");
        mensagemStatus.textContent = "‚úÖ Dados atualizados com sucesso!";
        mensagemStatus.className = "alert alert-success";
        mensagemStatus.style.display = "block";
        
        document.getElementById("novaSenha").value = "";
        
        window.valoresOriginais = {
            nome: data.nome,
            email: data.email,
            cpf: data.cpf,
            dataNascimento: data.dataNascimento,
            senha: data.senha
        };

        document.getElementById("userNome").textContent = "Bem-vindo, " + data.nome + "!";
        localStorage.setItem("nomePaciente", data.nome);
        
        document.getElementById("dataNascimentoPerfil").value = data.dataNascimento;
        
        setTimeout(() => {
            carregarPerfil();
        }, 1000);
    } catch (error) {
        console.error("Erro ao atualizar dados:", error);
        const mensagemStatus = document.getElementById("mensagemStatus");
        mensagemStatus.textContent = "‚ùå Erro ao atualizar dados: " + error.message;
        mensagemStatus.className = "alert alert-danger";
        mensagemStatus.style.display = "block";
    }

    return false;
  }

  function confirmarExclusaoConta() {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.setAttribute('tabindex', '-1');
    modal.setAttribute('aria-labelledby', 'confirmarExclusaoLabel');
    modal.setAttribute('aria-hidden', 'true');
    modal.innerHTML = `
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmarExclusaoLabel">Confirmar Exclus√£o</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p class="text-danger">‚ö†Ô∏è Aten√ß√£o! Esta a√ß√£o n√£o pode ser desfeita.</p>
            <p>Tem certeza que deseja excluir sua conta? Todos os seus agendamentos ser√£o cancelados.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-danger" onclick="excluirConta()">Sim, Excluir Conta</button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    modal.addEventListener('hidden.bs.modal', () => {
      document.body.removeChild(modal);
    });
  }

  async function excluirConta() {
    const mensagemStatus = document.getElementById("mensagemStatus");
    mensagemStatus.textContent = "Processando exclus√£o da conta...";
    mensagemStatus.className = "alert alert-info";
    mensagemStatus.style.display = "block";

    try {
      // Primeiro, buscar todos os agendamentos do paciente
      const response = await fetch("http://localhost:8080/consultas/listar");
      const consultas = await response.json();
      
      // Filtrar consultas do paciente
      const consultasPaciente = consultas.filter(c => c.pacienteId === parseInt(idPaciente));
      
      // Deletar cada consulta
      await Promise.all(consultasPaciente.map(consulta => 
        fetch(`http://localhost:8080/consultas/deletar/${consulta.id}`, {
          method: "DELETE"
        })
      ));

      // Ap√≥s deletar todas as consultas, deletar a conta
      const deleteResponse = await fetch(`http://localhost:8080/paciente/deletar/${idPaciente}`, {
        method: "DELETE"
      });

      if (!deleteResponse.ok) {
        throw new Error("Erro ao excluir conta");
      }

      mensagemStatus.textContent = "‚úÖ Conta exclu√≠da com sucesso! Redirecionando...";
      mensagemStatus.className = "alert alert-success";
      mensagemStatus.style.display = "block";
      
      // Limpar dados do localStorage
      localStorage.clear();
      
      // Redirecionar para a p√°gina inicial ap√≥s 2 segundos
      setTimeout(() => {
        window.location.href = "index.html";
      }, 2000);
    } catch (error) {
      mensagemStatus.textContent = "‚ùå Erro ao excluir conta: " + error.message;
      mensagemStatus.className = "alert alert-danger";
      mensagemStatus.style.display = "block";
      console.error("Erro ao excluir conta:", error);
    }
  }

  // Nova fun√ß√£o para agendar nova consulta
  function agendarNovaConsulta(servico, data, horario) {
    // Mudar para a se√ß√£o de servi√ßos
    mudarConteudo('Servi√ßos', 'Veja abaixo os servi√ßos dispon√≠veis para voc√™.', document.getElementById('linkServicos'));
    
    // Encontrar o card do servi√ßo correspondente
    const servicoId = servico.toLowerCase().replace(/[^a-z0-9]/g, '');
    const formId = `form${servicoId.charAt(0).toUpperCase() + servicoId.slice(1)}`;
    
    // Abrir o formul√°rio de agendamento
    setTimeout(() => {
        const btnAgendar = document.querySelector(`button[onclick="abrirAgendamento('${servico}', '${formId}')"]`);
        if (btnAgendar) {
            btnAgendar.click();
            
            // Preencher a data e hor√°rio
            setTimeout(() => {
                const inputData = document.getElementById("dataAgendamento");
                const selectHorario = document.getElementById("horarioAgendamento");
                
                if (inputData) inputData.value = data;
                if (selectHorario) selectHorario.value = horario;
                
                // Validar a data selecionada
                if (inputData) validarDataAgendamento(data);
            }, 100);
        }
    }, 100);
  }

  function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
    document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
  }

  // Fechar menu ao clicar em um link (mobile)
  document.querySelectorAll('.sidebar a').forEach(link => {
    link.addEventListener('click', () => {
      if (window.innerWidth <= 768) {
        toggleSidebar();
      }
    });
  });

  // Ajustar layout ao redimensionar a janela
  window.addEventListener('resize', () => {
    if (window.innerWidth > 768) {
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      sidebar.classList.remove('active');
      overlay.classList.remove('active');
      document.body.style.overflow = '';
    }
  });
</script>

</body>
</html>